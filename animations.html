<!doctype html>
<html>
	<head>
		<script type="text/javascript" src="C2D.js"></script>
		<script type="text/javascript" src="sprite.js"></script>
		<script type="text/javascript" src="utility.js"></script>
		<script type="text/javascript">
			var times = 3, speed = 50, feet = {
                    type : "feet",     
                    movement : "d",
                    stroke : "blue",
                    onadd : function(p) {
                        this.width = p.width / 2;
                        this.height = p.height / 2;
                        this.location = [this.width / 2, p.height - this.height, 1];
                    },
                    collidesWith : {
                        feet : function(feet) { 
                            var p = feet.parent, pt = this.parent;
                            p.location[0] -= p.dx * c2d.getTimeInterval();
                            p.location[1] -= p.dy * c2d.getTimeInterval();
                            pt.location[0] -= pt.dx * c2d.getTimeInterval();
                            pt.location[1] -= pt.dy * c2d.getTimeInterval();
                            p.dx = p.dy = pt.dx = pt.dy = 0;
                        },
                        "" : function() {}
                    }
                }, keys =  {
                up : stdKey("dy", "up", -1),
                down : stdKey("dy", "down", 1),
                left : stdKey("dx", "left", -1),
                right : stdKey("dx", "right", 1),
                space : {
                    press : function() {
                        if(!this.isMoving()) {
                            this.disabled = true;
                            this.sprites[0].visible = false;
                            this.sprites[1].visible = true;                     
                            var name = this.sprites[0].sprites[0].animation.name;
                            this.attack.location = this.location.slice();
                            if(name == "up" || name == "down") {
                                this.attack.location[0] += this.attack.width / 2;
                            }
                            if(name == "left" || name == "right") {
                                this.attack.location[1] += this.attack.height / 2;                                
                            }
                            if(name == "right") {
                                this.attack.location[0] += this.attack.width;
                            }
                            if(name == "down") {
                                this.attack.location[1] += this.attack.height;
                            }  
                            if(name.indexOf("animation-") !== 0) {
                                name = "animation-" + name;
                            }
                            for(var i = 0; i < this.sprites[0].sprites.length; i++) {
                                this.sprites[1].sprites[i].animate(name);
                            }  
                            this.attack.visible = 1;
                        }
                    }
                }
            };
            function animations(columns) {
                return {
        			"up" : {
    					sequence : [0]
    				},
    				"animation-up" : {
    					sequence : H(1, columns, times),
                        next : next
    				},
    				"left" : {
    					sequence : [columns]
    				},
    				"animation-left" : {
    					sequence : H(columns + 1, columns * 2, times),
                        next : next
    				},
    				"down" : {
    					sequence : [columns * 2]
    				},
    				"animation-down" :  {
    					sequence : H(columns * 2 + 1, columns * 3, times),
                        next : next
    				},
    				"right" : {
    					sequence : [columns * 3]
    				},
    				"animation-right" :  {
    					sequence : H(columns * 3 + 1, columns * 4, times),
                        next : next                    
				    }
                };
            }
            function next() {
                var p = this.parent.parent;
                p.attack.visible = 0;
                p.disabled = false;
                p.sprites[0].visible = true;
                p.sprites[1].visible = false;
            }
            function stdKey(x_or_y, direction, sign) {
               return {
                    press : function() {
                        this.keys[direction].down.call(this, direction);
                    },
                    down : function() {
                        if(this.sprites[0].sprites[0].animation.name.indexOf("animation-") != 0) {
                            this[x_or_y] += sign * speed;
                            for(var i = 0; i < this.sprites[0].sprites.length; i++) {
                                this.sprites[0].sprites[i].animate("animation-" + direction);
                            }
                        }
                    },
                    up : function() {
                        var name = this.sprites[0].sprites[0].animation.name;
                        if(name.indexOf(direction) != -1) {
                            this[x_or_y] = 0;                    
                            for(var i = 0; i < this.sprites[0].sprites.length; i++) {
                                this.sprites[0].sprites[i].animate(direction);
                            }
                        }
                    }
                };
            }
			function addSprite(sprite, image, dir, columns) {
				sprite.add(new Sprite({
					image : dir + image + ".png",
					columns : columns,
					rows : 4,
					animations : animations(columns),
                    type : dir,            
				}, function() {
                    this.animate("down");
                }));
			}
            var walkcycle_dir = "images/resources/walkcycle/", slash_dir = "images/resources/slash/";
			var walkcycle = {
					width : 64,
					height : 64,
					init : function() {
						addSprite(this, "BODY_male", walkcycle_dir, 9);
						addSprite(this, "HEAD_plate_armor_helmet", walkcycle_dir, 9);
						addSprite(this, "LEGS_plate_armor_pants", walkcycle_dir, 9);
						addSprite(this, "TORSO_plate_armor_torso", walkcycle_dir, 9);
						addSprite(this, "TORSO_plate_armor_arms_shoulders", walkcycle_dir, 9);
						addSprite(this, "FEET_plate_armor_shoes", walkcycle_dir, 9);
						addSprite(this, "HANDS_plate_armor_gloves", walkcycle_dir, 9);
						addSprite(this, "WEAPON_shield_cutout_body", walkcycle_dir, 9);
					}
			};
    		var slash = {
					width : 64,
					height : 64,
                    visible : false,
					init : function() {
						addSprite(this, "BODY_human", slash_dir, 6);
						addSprite(this, "HEAD_plate_armor_helmet", slash_dir, 6);
						addSprite(this, "LEGS_plate_armor_pants", slash_dir, 6);
						addSprite(this, "TORSO_plate_armor_torso", slash_dir, 6);
						addSprite(this, "TORSO_plate_armor_arms_shoulders", slash_dir, 6);
						addSprite(this, "FEET_plate_armor_shoes", slash_dir, 6);
						addSprite(this, "HANDS_plate_armor_gloves", slash_dir, 6);
						addSprite(this, "WEAPON_dagger", slash_dir, 6);
					}
			};
            var item_slot = {
                swaps : true,
                limit : 1,
                type : "item_slot",
                stroke : "black",
                fill : "gray",
                width : 32,
                height : 32,
                priority : 4,
                onadd : function(p) {      
                    var s = new Sprite(item);  
                    s.drop(this);     
                    p.add(s);
                }
            };      
            var weapons = ["axe", "bigclub", "bow", "claw", "dagger", "halberd", "hammer"], index = 0, item = {
                priority : 5,
                width : 32,
                height : 32,
                ondrop : {
                    "item_slot" : function(item_slot) {
                        this.location = item_slot.location.slice(0);
                        this.stick();
                    }
                },
                init : function() {
                    var me = this;
                    index++;
                    img("images/resources/weapons/icon_" + weapons[0] + index + ".png", function(img) {
                        me.image = img;
                    });
                    if((index = index % 3) == 0) {
                        weapons.shift();
                    }
                },
                draggable : true
            };                    
			var c2d = new C2D("screen", function() {
                var screen = new Sprite({
                    width : 640,
                    height : 480
                });
                for(var i = 0; i < 10; i++) {
                    for(var j = 0; j < 8; j++) {
                        screen.add(new Sprite({
                            index : 10,
                            location : [64 * i, 64 * j],
                            width : 64,
                            height : 64,
                            image : "images/resources/environment/town.png",
                            columns : 10,
                            rows : 3,
                            priority : -5
                        }));
                    }
                }
                var inventory = new Sprite({
                    clips : false,
                    width : 32 * 3 + 10 * (3 + 1),
                    height : 32 * 7 + 10 * (7 + 1),
                    priority : 3,
                    fill : "gray",
                    stroke : "black",
                    onadd : function(p) {
                        this.location = [this.parent.width - this.width - 1, 1, 1];
                    }
                });
                for(var i = 0; weapons.length;) {
                    for(var j = 1; j < 4; i++, j++) {
                        var c = i % 3, r = Math.floor(i / 3);
                        inventory.add(new Sprite(item_slot, function() {
                            this.location = [c * 32 + (c + 1) * 10, r * 32 + (r + 1) * 10, 1];
                        }));
                    }
                }
                screen.add(inventory);
                screen.add(new Sprite({
                    image : "images/resources/combat_dummy/BODY_animation.png",
                    rows : 1,
                    columns : 8,
                    animations : {
                        spin : {
                            sequence : H(1, 8, times),
                            next: "stop"
                        },
                        stop : { sequence : [0] }
                    },
                    init : function() { this.add(new Sprite(feet)); },
                    stroke : "blue",
                    location : [100, 100],
                    type : "dummy",
                    collidesWith : {human:function(){}}
                }));
                screen.add(new Sprite({
                	width : 64,
    				height : 64,
                    movement : "d",
                    keys : keys,
                    type : "human",
                    stroke : "blue",
                    collidesWith : {dummy : function(){}},
                    onadd : function() {
                        screen.add(this.attack = new Sprite({
                            width : 32,
                            height : 32,
                            visible : 0,
                            movement : "d",
                            stroke : "red",
                            collidesWith : {
                                dummy : function(dummy) {
                                    if(dummy.animation.name != "spin") { dummy.animate("spin"); }
                                }
                            }
                        }));
                    }
    			}, function() {
    				this.add(new Sprite(walkcycle));
                    this.add(new Sprite(slash));
                    this.add(new Sprite(feet));
    			}));
                var slider = {
                    component : "slider",
                    onchange : function(v, lv) {
                        DEBUG(this.id, ["New Value : ", v, ", Old Value : ", lv].join(""));
                    },
                    init : function() { this.id = id++; }
                }, id = 1;
                screen.add(new Sprite(slider, function() {
                    this.location = [100, 450];
                    this.width = 100;
                    this.height = 20;  
                }));
                screen.add(new Sprite(slider, function() {
                    this.width = 20;
                    this.height = 100;
                    this.location = [210, 370];
                    this.min = -2;
                    this.max = 3;      
                    this.round = Math.round;
                }));
                screen.add(new Sprite(slider, function() {
                    this.width = 20;
                    this.height = 100;
                    this.location = [240, 370];
                    this.min = -50;
                    this.max = 50;
                    this.round = step(10);
                }));
                screen.add(new Sprite({
                    text : [
                        {
                            content : "Hello World\nI am demonstrating a textbox right now.",
                        },
                        "\n",
                        {
                            content : "Look I can change "                            
                        },
                        {
                            content : "style ",
                            style : "italic"
                        },
                        {
                            content : "weight ",
                            weight : "bold "
                        },
                        {
                            content : "color ",
                            color : "red"
                        },
                        {
                            content : "family",
                            family : '"Courier New"'
                        },
                        {
                            content : " and "
                        },
                        {
                            content : "size",
                            size : 24
                        },
                        {
                            content : "size",
                            size : 48
                        }
                        
                    ],
                    width : 200,
                    height : 100,
                    location : [400, 350],
                    component : "textbox"
                }));
                screen.add(new Sprite({
                    width : 80,
                    height : 40,
                    text : { content : "Full Screen" },
                    component : "button",
                    onmouseclick : function() { c2d.fullScreen(); },
                    onadd : function(p) { this.location = [10, p.height - this.height - 10, 1]; }
                }));
                audio("images/resources/audio/win_music", function playForever() {
                    audio("images/resources/audio/win_music", arguments.callee);                    
                });
				c2d.setScreen("screen", screen);
				c2d.start();
			});
		</script>
        <style type="text/css">
            td {
                width : 16px;
                height : 16px;
                border : 1px solid black;
                text-align : center;
            }
        </style>
	</head>
	<body>
		<canvas id="screen">Canvas not supported.</canvas>
        <table>
            <tr>
                <td></td>
                <td>&uarr;</td>
                <td></td>
            </tr>
            <tr>
                <td class="left">&larr;</td>
                <td>&darr;</td>
                <td>&rarr;</td>
            </tr>
        </table>
        Movement
        <table>
            <tr>
                <td>SPACE</td>
            </tr>
        </table>        
        Attack
	</body>
</html>